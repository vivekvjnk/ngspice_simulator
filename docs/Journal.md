# Hardware Simulation Environment

# Challenges identified so far in VHL journey
Started by designing a SPICE MCP simulation server. 
1. While implementing SPICE simulator, faced challenges with flat SPICE file format. To resolve these issues, tried to separate control statements from the model definition statements. This lead to issues related to merging logic required for constructing simulation code. Now the agent is forced to use models from the model library and construct separate control script. First we tried importing entire model definition files into the merged file. Observed complexity explosion right after few experiments. Then decided to use import statements instead of merging model definition. Tried basic implementation, but failed.
After this failure, reflected on the final objective of the experiment. Started VHL as part of BMS development. The circuits we are trying to simulate are BMS, related sub circuits and the Li-ion cell model. All the experiments were carried out focusing on EIS cell modelling. Electrochemical Impedence Spectrum(EIS) modelling require impedence measurements at wide veriety of frequencies to accurately build the battery model. First experiments on VHL were focused on designing EIS simulation test benches. Once we saw the failure of experiments, started exploring feasibility of practical EIS data measurements. This lead us the major challenge in designing the EIS test set-up: 1. 10mV sine wave generator with frequency range 10 milli hertz to 100 mega hertz. The feedback mechanisms should be highly accurate to achieve this level of precision. With present technology, it is hard(or nearly impossible) to construct an embedded mechanism which can do EIS calibration in runtime. This lead us to questioning the ncessity of such high accuracy simulation. 
Since progress felt stale in this direction, we decided to move on to the BMS design itself. 
2. Identified major ICs for designing battery management system. Understood necessity of the major circuit components. Then started exploring methods to convert reference schematic image into KiCAD schematic. 
   - Explored Netlistify : This tool converts schematic images into SPICE netlists
      - Went through the Paper and Code base
      - Cloned the code and ran it locally
      - With example test data, model was working well and good
      - Along with the image, there is one text file fed into the system. Couldn't understand what it is. Without spending more time on analysing it, we moved onto agentic parsing of netlist. 
      - ie, we didn't validate netlistify on our local data
      - Do we have local data? As of now, no.. We have the schematic image. But that is not converted to KiCAD schematic or SPICE code. 
   - Experimented with Gemini on generating SPICE netlists by feeding schematic image.
      - Gemini failed to generate SPICE for the entire schematic image
      - If image is segmented into small sub circuit images, Gemini could generate SPICE code. 
      - Hence we designed "Function 1" using SAMv3 image segmentation model.
      - Through this approach, we could isolate sub circuits from our schematic image. The schematic image used was modular and well segmented into sub circuits, because of which we could easily validate the results.
   - Then designed "Function 2" to extract SPICE code from each of the sub-circuit. 
      - At this point, we started to see the next hurddle. We don't have ground truth to validate our results. 
      - We don't have enough expertise with the SPICE code to analyse it. 
      - Here we are, reflecting back, looking for alternatives, without knowing what to do next

   - We moved further and developed prototypes for function 3 and 4. 
      - Intent of function 3 was to review the SPICE code generated by function 2. Ground truth for the review was the source schematic image. It was observed that, the review agent did not add significant value gain to the pipeline. 
      - Function 4 was supposed to integrate all the sub-circuit SPICE codes into a final SPICE code. 
   
   - At this point, we found the insufficiency of SPICE code as an intermediate circuit representation. SPICE code doesn't contain spacial information of the electrical circuit. Hence desiging schematic or pcb design from SPICE code is not feasible. 
   - Then we took a step back and analysed the key challenges. Identified, we desparately need a unified intermediate representation for electronic circuit design. 
   - This realisation lead us to tscircuit Circuit JSON. Circuit JSON was designed for this exact purpose. Single representation of electronic circuit from which SPICE, Schematic and PCB layout information can be derived.

# Milestone 1 for VHL 
* Create PCB schematic for BQ79616 using VHL
* Inputs: 
    - Reference design schematic in image format
* Output:
    - tscircuit equivalent of the reference schematic 

* Key actors in the system:
    - LLM Agent/s
    - Execution environment: VHL
    - Input provisioning and transformation subsystem (Optional)
        - Segment input circuit images if necessary
        - Configure top level input prompts
        - Answer agent questions

* Agent responsibilities 
    - Understand the input schematic; Components and accurate connections.  : NO VHL Interaction
    - Check if components are available in library                          : VHL Interaction (Search functionality)
        - If not create component; validate; then save in the library       : VHL Interaction (Search functionality)
    - Identify if any subcircuits/modules are required to simplify          : No VHL interaction
    - Create all the circuits in .tsx format; validate                      : VHL Interaction (Upload .tsx files, Validate .tsx scripts, 
                                                                                               Return validation resuls )
* VHL Functionalities
    - Derived from agent interactions with VHL
    1. Search funcitonality
        - If component is available in library
        - Return minimum necessary information about the component
    2. Upload and validate .tsx file to a specific location.
        - Return validation resutls
        - If agent want to modify the uploaded file, re-upload the entire file. Operation is immutable

    3. Initialization of `tscircuit` project
        - Create a `tscircuit` project 
        - For the very first interaction with agent, respond with the project details(directory hierarchy and other relevant info.)
        - Every operation should use relative path with respect to the project root

* VHL implementation 
    - MCP server 


# Library manager
├── dist
├── Dockerfile
├── package.json
├── pnpm-lock.yaml
├── README.md
├── src
│   ├── config
│   │   └── paths.ts                : All project paths live here(project root, library path etc)
│   ├── index.ts                    : Process entry point, starts mcp server, load config
│   ├── library
│   │   ├── index.ts                : Public api for library, Exposes addComponent(), listLocal(), searchLibrary()
│   │   ├── local                   : All local .tsx libraries are stored in this directory
│   │   └── validator.ts            : Deterministic validation flow is implemented here
│   ├── mcp
│   │   ├── server.ts               : MCP server, tool registration, request dispatch
│   │   └── tools
│   │       ├── addComponent.ts     : MCP tool to add component
│   │       ├── listLocal.ts        : MCP tool for listing all local components
│   │       └── searchLibrary.ts    : MCP tool for searching components
│   └── runtime
│       ├── filesystem.ts           : Thin wrapper above filesystem
│       └── tscircuit.ts            : TSX file execution happens here
├── tests
│   ├── mcp                         : MCP server test cases
│   │   └── library.test.ts
│   └── runtime.test.ts             : Runtime test cases
└── tsconfig.json
